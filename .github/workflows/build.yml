name: 'ğŸ”§ CI - Build & Test'

# ç”¨äºæ„å»ºã€æµ‹è¯•å’ŒéªŒè¯cl-nestjs-opentelemetryåº“çš„æŒç»­é›†æˆå·¥ä½œæµ
# åœ¨é’ˆå¯¹mainåˆ†æ”¯çš„æ‹‰å–è¯·æ±‚ä»¥åŠæ¨é€åˆ°æ‰€æœ‰åˆ†æ”¯ï¼ˆå‘å¸ƒæäº¤é™¤å¤–ï¼‰æ—¶è¿è¡Œ
# åœ¨å¤šä¸ªNode.jsç‰ˆæœ¬ä¸Šè¿›è¡Œæµ‹è¯•ä»¥ç¡®ä¿å…¼å®¹æ€§

on:
  pull_request:
    branches: [main]
  push:
    # åœ¨æ‰€æœ‰åˆ†æ”¯ï¼ˆåŒ…æ‹¬mainåˆ†æ”¯ï¼‰ä¸Šè¿è¡Œï¼Œä½†è·³è¿‡å‘å¸ƒæäº¤
    branches: ['**']

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15 # Prevent indefinite hanging
    # Skip if it's a release commit to avoid conflicts with release workflow
    if: >-
      ${{ !startsWith(github.event.head_commit.message, 'chore: release v') }}

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm Package Manager
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: ğŸŸ¢ Setup Node.js 22 (Build)
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: ğŸ§¹ Clear pnpm cache if needed
        run: |
          echo "Checking pnpm cache status..."
          pnpm store status || pnpm store prune || true

      - name: ğŸ“š Install Dependencies
        timeout-minutes: 5
        run: |
          echo "Installing root dependencies..."
          pnpm install --no-frozen-lockfile
          echo "Installing playground dependencies..."
          cd playground && pnpm install --no-frozen-lockfile

      - name: ğŸ” Run Quality Checks (Lint & Test)
        timeout-minutes: 10
        run: |
          echo "Running linter..."
          pnpm lint
          echo "Running tests with coverage..."
          pnpm coverage
          echo "Building library..."
          pnpm build

      - name: âœ… Verify Build Outputs
        run: |
          # Check required files exist
          required_files=(
            "dist/index.mjs" "dist/index.cjs" "dist/index.d.ts"
            "dist/index.d.mts" "dist/index.d.cts"
          )

          for file in "${required_files[@]}"; do
            if [[ ! -f "$file" ]]; then
              echo "âŒ Missing: $file"
              exit 1
            fi
          done

          echo "âœ… All build outputs verified"

      - name: ğŸ“Š Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            dist/
            package.json
            pnpm-lock.yaml
          retention-days: 1

  # Compatibility test job - verify library works on Node.js 20
  compatibility:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10

    strategy:
      matrix:
        node-version: [20]
      fail-fast: false

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm Package Manager
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }} (Compatibility Test)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: ğŸ“¥ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts
          path: .

      - name: ğŸ“š Install Runtime Dependencies Only
        timeout-minutes: 3
        run: |
          echo "Installing production dependencies for Node.js ${{ matrix.node-version }} compatibility test..."
          # Skip scripts to avoid husky prepare script error in CI
          pnpm install --prod --no-frozen-lockfile --ignore-scripts

      - name: ğŸ§ª Test Module Structure and Syntax on Node.js ${{ matrix.node-version }}
        timeout-minutes: 2
        run: |
          echo "Testing module structure on Node.js ${{ matrix.node-version }}..."

          # æµ‹è¯• CJS æ¨¡å—ç»“æ„
          node -e "
            const fs = require('fs');
            const cjsPath = './dist/index.cjs';
            if (!fs.existsSync(cjsPath)) {
              throw new Error('CJS file not found: ' + cjsPath);
            }
            const cjsContent = fs.readFileSync(cjsPath, 'utf8');
            if (!cjsContent.includes('module.exports') && !cjsContent.includes('exports.')) {
              throw new Error('CJS file does not contain exports');
            }
            console.log('âœ… CJS module structure verified');
          "

          # æµ‹è¯• ESM æ¨¡å—ç»“æ„
          node --input-type=module -e "
            import fs from 'fs';
            const esmPath = './dist/index.mjs';
            if (!fs.existsSync(esmPath)) {
              throw new Error('ESM file not found: ' + esmPath);
            }
            const esmContent = fs.readFileSync(esmPath, 'utf8');
            if (!esmContent.includes('export')) {
              throw new Error('ESM file does not contain exports');
            }
            console.log('âœ… ESM module structure verified');
          "

          echo "âœ… Node.js ${{ matrix.node-version }} compatibility verified"
